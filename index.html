<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Programaciones mensuales</title>
<style>
  :root{
    --bg:url("https://raw.githubusercontent.com/dla-tech/Media-privada/refs/heads/main/IMG_7782.jpeg");
    --card: rgba(255,255,255,.86);
    --ink: #0b1421;
    --accent: #2563eb;
    --shadow: 0 8px 20px rgba(0,0,0,.15);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink);
    background:#0b1421; min-height:100svh;
  }
  body::before{content:"";position:fixed;inset:0;background-image:var(--bg);background-size:cover;background-position:center;filter:brightness(.9) saturate(.9);z-index:-2}
  body::after{content:"";position:fixed;inset:0;background:linear-gradient(180deg,rgba(8,11,20,.35),rgba(8,11,20,.6));z-index:-1}

  /* ===== Splash / Pantalla de carga ===== */
  .loading,
  .loading body { overflow:hidden; height:100%; }
  #loader {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    z-index: 100000;
    opacity: 1;
    transition: opacity 2000ms ease;
  }
  #loader img{
    position:absolute;
    inset:0;
    width:100vw;
    height:100vh;
    object-fit:cover;
    object-position:50% 45%;
    z-index:1;
    user-select:none;
    -webkit-user-drag:none;
  }
  #loader.hide { opacity: 0; pointer-events: none; }

  /* Canvas de fuego detrás del logo */
#loader-canvas{
  position:fixed;
  top:0; left:0;
  width:100vw;
  height:100vh;
  display:block;
  z-index:0;
  pointer-events:none;
}
#loader img{ position:relative; z-index:1; }

  /* ===== NAV responsive y ordenado ===== */
  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter:saturate(1.2) blur(8px);
    background:rgba(255,255,255,.55);
    border-bottom:1px solid rgba(0,0,0,.08);
  }
  /* Auto-ocultar barra en scroll */
  header{ transition: transform .4s ease; will-change: transform; }
  header.hide{ transform: translateY(-100%); }

  /* MÓVIL: grilla de botones iguales */
  .nav{
    max-width:1100px; margin:0 auto; padding:8px 10px;
    display:grid; gap:8px;
    grid-template-columns: repeat(2, 1fr); /* 2 columnas en móvil */
  }
  .nav .spacer{ display:none; } /* no hace falta en móvil */
  .nav a{
    display:block;
    text-align:center;
    text-decoration:none;
    font-weight:600;
    color:#0b1421;
    padding:10px 10px;
    font-size:14px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.5);
  }
  .nav a.active{
    background:#e9efff;
    color:#2563eb;
    border-color:rgba(37,99,235,.25);
  }

  /* iOS compacto: mantén 2 columnas pero reduce tamaño visual */
  @supports (-webkit-touch-callout: none){
    @media (max-width: 430px){
      .nav{ padding:8px 10px; gap:8px; }
      .nav a{ padding:9px 10px; font-size:13.5px; border-radius:10px; }
    }
    @media (max-width: 360px){
      .nav{ padding:6px 8px; gap:6px; }
      .nav a{ padding:8px 8px; font-size:13px; }
    }
  }

  /* TABLET+: vuelve a barra horizontal */
  @media (min-width: 768px){
    .nav{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 16px;
    }
    .nav .spacer{ flex:1; display:block; }
    .nav a{
      padding:10px 12px;
      min-width:auto;
      background:transparent;
      border:0;
    }
    .nav a.active{
      background:#e9efff;
      border:0;
    }
  }
  .wrap{max-width:1100px; margin:0 auto; padding:22px 16px}

  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
  h1,h2{color:#fff; text-align:center; margin:10px 0 14px}
  section{scroll-margin-top:80px; margin-bottom:22px}
  iframe{border:0; width:100%; border-radius:10px}
  .grid{display:grid; gap:12px}
  @media(min-width:720px){
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  }
  .grid.cols-1{grid-template-columns:1fr}
  .subhead{margin:0 0 6px; font-weight:700; color:#0b1421}

  .btn{display:block; text-align:center; text-decoration:none; padding:14px 16px;
       border-radius:12px; font-weight:700; color:#fff}
  .btn-g{background:#34C759}
  .btn-i{background:#4285F4}
  .btn-d{background:#0f172a}
  .btn-y{background:#facc15; color:#000;}
  .btn-yt{background:#ff0000; color:#fff;}

  /* Live YouTube styles */
  .live-wrap { display:none; margin-top:10px; border-radius:12px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,.2); background:#000 }
  .live-head { display:flex; align-items:center; gap:8px; padding:10px 12px; color:#fff; font-weight:800; letter-spacing:.2px; background:linear-gradient(90deg,#b91c1c,#ef4444) }
  .live-dot { width:10px; height:10px; border-radius:999px; background:#fff; box-shadow:0 0 8px rgba(255,255,255,.9) }
  .live-player { position:relative; aspect-ratio:16/9; background:#000 }
  .live-player iframe { position:absolute; inset:0; width:100%; height:100%; border:0 }
  .live-cta { display:block; padding:10px 12px; text-align:center; text-decoration:none; color:#fff; font-weight:700; background:#111 }

  .note{font-size:.92em; opacity:.8}
  .list{margin:0; padding-left:18px}
  .footer{color:#e5e7eb; text-align:center; font-size:.9em; padding:26px 0}

  /* Modal contacto */
  .contact-modal {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.6);
    align-items:center; justify-content:center;
    z-index:10000;
  }
  .contact-modal .modal-content {
    background:#fff; padding:20px; border-radius:12px;
    text-align:center; max-width:300px; width:90%;
    box-shadow:0 6px 16px rgba(0,0,0,.25);
  }
  .contact-modal .btn {
    display:block; margin:10px 0; text-decoration:none;
    padding:12px; border-radius:8px; color:#fff; font-weight:600;
  }
  .contact-modal .btn-d {
    display:block;
    margin:10px 0;
    padding:12px;
    border-radius:8px;
    color:#fff;
    font-weight:600;
    background:#444;
    border:none;
    width:100%;
    text-align:center;
  }
  /* ===== Promo descarga ===== */
  .promo-wrapper{ position: relative; display:block; text-align:center; }
  .promo-wrapper img{
    display:block; margin:0 auto;
    max-width:100%; height:auto;
    border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.2)
  }
  .promo-overlay{ display:none !important; } /* ocultamos overlay dentro de la foto */
  #btn-descargar-promo{
    background:#ffd100; color:#000; font-weight:800; font-size:13.5px;
    border:none; padding:8px 12px; border-radius:10px; cursor:pointer;
    display:inline-block; margin:10px auto 0; box-shadow:0 2px 8px rgba(0,0,0,.25);
  }
  #btn-descargar-promo.hidden{ display:none !important; }
  .hidden{ display:none !important; }
  /* Botón de NOTIFICACIONES solo visible en app (standalone) */
  #btn-notifs {
    background:#ef4444; /* rojo inicial */
    color:#fff;
    border-color: rgba(0,0,0,.08);
  }
  #btn-notifs.loading { opacity:.85; }
  #btn-notifs.ok { background:#22c55e; } /* verde cuando activas */
  @media (display-mode: standalone) {
    #btn-install { display:none !important; }   /* ocultar DESCARGAR cuando es app */
    #btn-notifs { display:block !important; }   /* mostrar NOTIFICACIONES en la app */
  }

  /* Logo fijo girando en esquina inferior izquierda */
  .fixed-logo {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 80px;
    height: auto;
    z-index: 9999;
    pointer-events: none; /* evita interacción */
    animation: spinY 6s linear infinite;
    transform-style: preserve-3d;
  }

  @keyframes spinY {
    0% { transform: rotateY(0deg); }
    100% { transform: rotateY(360deg); }
  }
</style>
<style id="preload-style">
  body > *:not(#loader) {
    visibility: hidden;
  }
</style>
<script>
  // Bloquea scroll desde el primer paint
  document.documentElement.classList.add('loading');
</script>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0b1421">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
</head>
<body>

  <div id="loader" aria-label="Pantalla de carga">
    <img src="https://raw.githubusercontent.com/dla-tech/Media-privada/refs/heads/main/IMG_8023.jpeg"
         alt="Pantalla de carga"
         style="position:absolute; inset:0; width:100vw; height:100vh; object-fit:cover; z-index:1; user-select:none; -webkit-user-drag:none;">
  </div>


<header>
  <nav class="nav">
    <div class="spacer"></div>
    <a href="#calendarios" class="navlink">Calendarios</a>
    <a href="#redes" class="navlink">Redes sociales</a>
    <a href="#ubicacion-templo" class="navlink">Ubicación del templo</a>
    <a href="#ubicacion-cultos" class="navlink">Ubicación de los cultos</a>
    <a href="#proposito" class="navlink">Propósito</a>
    <a id="btn-notifs" class="navlink" href="#" style="display:none; font-weight:800;">NOTIFICACIONES</a>
    <a id="btn-install" class="navlink" href="#" style="background:#7c3aed; color:#fff; border-color: rgba(0,0,0,.08); font-weight:800;">Descargar Web</a>
  </nav>
</header>

<main class="wrap">

  <!-- CALENDARIOS -->
  <section id="calendarios">
    <h1 style="font-size:1.35em; line-height:1.25; font-weight:700;">
      Primera Iglesia Pentecostal de Jesucristo de Maunabo, P.R. Inc.
    </h1>
    <!-- Promoción dinámica -->
    <div id="promo-banner" style="display:none; margin:12px auto; text-align:center;">
      <div class="promo-wrapper">
        <img id="promo-img" src="" alt="Promoción" style="width:70%; max-width:500px;">
      </div>
      <button id="btn-descargar-promo" class="promo-btn">⬆️ DESCARGA LA PROMO ⬆️</button>
    </div>

<script>
  (function(){
    // ⬇️ Link de la imagen de promoción (déjalo vacío "" si NO hay promo)
    const promoLink = "https://raw.githubusercontent.com/dla-tech/Media-privada/refs/heads/main/7f6d0715-e757-4a11-a12a-771690367985.jpeg";

    const banner  = document.getElementById("promo-banner");
    const img     = document.getElementById("promo-img");
    const overlay = document.getElementById("promo-overlay");
    const btnPromo = document.getElementById("btn-descargar-promo");

    // Si no hay promo, ocultar todo el bloque y salir
    if (!promoLink) {
      if (banner) banner.style.display = "none";
      if (btnPromo) btnPromo.classList.add('hidden');
      return;
    }

    // Mostrar y preparar imagen
    if (img) img.src = promoLink;
    if (banner) banner.style.display = "block";
    if (btnPromo) btnPromo.classList.remove('hidden');
    if (overlay) overlay.classList.add('hidden'); // aseguramos que no se muestre el overlay

    // Descarga con nombre basado en fecha/hora actual
    const descargar = async () => {
      try {
        const res = await fetch(promoLink, { mode: 'cors', cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const blob = await res.blob();

        const d = new Date();
        const pad = n => String(n).padStart(2,'0');
        const fname = `Promo_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}.jpg`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error('❌ Error al descargar promo:', e);
        alert('No se pudo descargar la promoción ahora. Intenta más tarde.');
      }
    };

    // Click en botón debajo descarga
    if (btnPromo) {
      btnPromo.addEventListener('click', descargar);
    }
    // (opcional) si prefieres que la imagen también descargue, descomenta:
    // if (img) { img.style.cursor = 'pointer'; img.addEventListener('click', descargar); }
  })();
</script>
    <div class="card" style="margin-bottom:12px">
      <iframe
        src="https://calendar.google.com/calendar/embed?src=72086005a3ac9a324642e6977fb8f296d531c3520b03c6cf342495ed215e0186%40group.calendar.google.com&ctz=America%2FPuerto_Rico&bgcolor=%23f4f7fb&hl=en"
        title="Calendario Google" loading="lazy" referrerpolicy="no-referrer-when-downgrade" height="600">
      </iframe>
    </div>

    <div class="grid cols-3">
      <a id="btn-gcal" class="btn btn-g" href="#" target="_self">🟢 Añadir en Google Calendar (Android/PC)</a>
      <a id="btn-ios" class="btn btn-i" href="#" target="_self">📱 Añadir en Apple Calendar (iPhone/Mac)</a>
      <a id="btn-download" class="btn btn-y" href="#" target="_self">⬇️ Descargar Google Calendar</a>
    </div>

    <!-- Modal de elección para Google Calendar -->
    <div id="gcal-choice" class="contact-modal">
      <div class="modal-content">
        <h3 style="margin:0 0 10px">¿Cómo quieres abrirlo?</h3>
        <a id="gcal-open-web" class="btn btn-g" href="#">🌐 Abrir en la web</a>
        <button id="gcal-open-app" class="btn-d">📱 Abrir en la app</button>
        <button id="gcal-cancel" class="btn-d" style="background:#6b7280">Cancelar</button>
      </div>
    </div>

    <p class="card note" style="margin-top:12px">
      📌 Todo cambio en la programación de la iglesia se reflejará automáticamente en tu calendario.
    </p>
  </section>

  <!-- REDES SOCIALES -->
  <section id="redes">
    <h2>Redes sociales</h2>
    <div class="card">
      <div class="grid cols-1">
        <a class="btn btn-yt" href="https://youtube.com/@pipjm9752?si=r3nrs4hxzxk-OVmI" target="_blank" rel="noopener">▶️ YouTube</a>
        <!-- LIVE (auto) -->
        <div id="live-wrap" class="live-wrap">
          <div class="live-head"><span class="live-dot"></span> EN VIVO AHORA</div>
          <div class="live-player" id="live-player"></div>
          <a id="live-cta" class="live-cta" href="https://www.youtube.com/@pipjm9752/live" target="_blank" rel="noopener">Ver en YouTube</a>
        </div>
        <a class="btn btn-d" href="mailto:pipjm1@gmail.com">✉️ pipjm1@gmail.com</a>
      </div>
    </div>
  </section>

  <!-- UBICACIÓN TEMPLO -->
  <section id="ubicacion-templo">
    <h2>Ubicación del templo</h2>
    <div class="card">
      <p><strong>Dirección:</strong> <a href="https://maps.app.goo.gl/4R9ZXAmw1ZcnBTL49?g_st=ipc" target="_blank" rel="noopener">Ver en Google Maps</a></p>
      <a href="https://maps.app.goo.gl/4R9ZXAmw1ZcnBTL49?g_st=ipc" target="_blank" rel="noopener">
        <img src="https://raw.githubusercontent.com/dla-tech/Media-privada/refs/heads/main/IMG_7782.jpeg" alt="Ubicación del templo" style="width:100%; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,.25)">
      </a>
    </div>
  </section>

  <!-- UBICACIÓN CULTOS -->
  <section id="ubicacion-cultos">
    <h2>Ubicación de cultos evangelísticos</h2>
    <div class="card">
      <p>Algunos servicios se realizan en ubicaciones distintas:</p>
      <div class="grid cols-2">
        <div>
          <p class="subhead"><span id="lbl-martes">Martes</span></p>
          <p><strong id="title-martes">Culto evangelístico</strong><br><span id="addr-martes">(TODO: dirección)</span></p>
          <iframe src="https://www.google.com/maps?q=Maunabo%20Puerto%20Rico&output=embed"
                  height="260" loading="lazy" title="Culto martes"></iframe>
        </div>
        <div>
          <p class="subhead"><span id="lbl-miercoles">Miércoles</span></p>
          <p><strong id="title-miercoles">Culto evangelístico</strong><br><span id="addr-miercoles">(TODO: dirección)</span></p>
          <iframe src="https://www.google.com/maps?q=Maunabo%20Puerto%20Rico&output=embed"
                  height="260" loading="lazy" title="Culto miércoles"></iframe>
        </div>
      </div>
    </div>
  </section>

  <!-- PROPOSITO -->
  <section id="proposito">
    <h2>Propósito</h2>
    <div class="card">
      <p><strong>Nuestro propósito</strong> es: “Llevar el evangelio a toda criatura, dar un mensaje de esperanza, mostrar el amor de Dios al mundo y ayudar al necesitado.”</p>
      <h3 style="margin-top:16px; font-size:1.1em; color:#0b1421;">Horarios de cultos y actividades</h3>
      <ul class="list">
        <li><strong>Lunes:</strong> Culto de oración en el templo — 7:00 p.m.</li>
        <li><strong>Martes y Miércoles:</strong> Cultos evangelísticos en Maunabo y lugares limítrofes — 7:00 p.m.</li>
        <li><strong>Jueves:</strong> Culto de la Sociedad de Niños, oración o estudio bíblico — 7:00 p.m.</li>
        <li><strong>Viernes:</strong> Culto de las Sociedades de Damas, Caballeros y Jóvenes — 7:00 p.m.</li>
        <li><strong>Sábado:</strong> Altar familiar. (Una vez al mes, ayuno congregacional) — 6:00 a.m.</li>
        <li><strong>Domingo:</strong>
          <ul>
            <li>Oración/Ayuno — desde las 6:00 a.m.</li>
            <li>Apertura de Escuela Bíblica — 8:45 a.m.</li>
            <li>Cierre de Escuela Bíblica — 10:45 a.m.</li>
            <li>Comienzo del culto de adoración — 11:15 a.m.</li>
          </ul>
        </li>
      </ul>
    </div>
  </section>

  <!-- CONTACTO -->
  <div class="footer">© 2025 — Iglesia. Todos los derechos reservados.</div>
</main>

<!-- =========================
     ICS embebido (SEPTIEMBRE 2025)
     ========================= -->
<script id="ics-data" type="text/plain" style="display:none;">
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Iglesia//Calendario Sept 2025//ES
CALSCALE:GREGORIAN
METHOD:PUBLISH

BEGIN:VEVENT
UID:20250902T190000-SEC3@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250902T190000
DTEND:20250902T203000
SUMMARY:Culto Evangelístico — Sección III, Sector Florida-Calzada
LOCATION:Sector Florida-Calzada, Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250903T190000-SEC2@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250903T190000
DTEND:20250903T203000
SUMMARY:Culto Evangelístico — Sección III, Sector Las Lajas-Matuyas
LOCATION:Sector Las Lajas-Matuyas, Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250909T190000-CALIMANO@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250909T190000
DTEND:20250909T203000
SUMMARY:Culto Evangelístico — Parque Pasivo de Calimano
LOCATION:Parque Pasivo de Calimano, Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250910T190000-CALIMANO@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250910T190000
DTEND:20250910T203000
SUMMARY:Culto Evangelístico — Parque Pasivo de Calimano
LOCATION:Parque Pasivo de Calimano, Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250916T190000-EGIDA@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250916T190000
DTEND:20250916T203000
SUMMARY:Culto Evangelístico — Sección II (al lado de la Égida, Emajagua)
LOCATION:Égida de Emajagua, Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250917T190000-MALOJA@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250917T190000
DTEND:20250917T203000
SUMMARY:Culto Evangelístico — Maloja (Emajagua)
LOCATION:Maloja, Emajagua, Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250923T190000-SEC3@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250923T190000
DTEND:20250923T203000
SUMMARY:Culto Evangelístico — Sección III
LOCATION:Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250924T190000-SEC2@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250924T190000
DTEND:20250924T203000
SUMMARY:Culto Evangelístico — Sección II
LOCATION:Maunabo, PR
END:VEVENT

BEGIN:VEVENT
UID:20250930T190000-CRISTAL@iglesia
DTSTAMP:20250801T120000Z
DTSTART:20250930T190000
DTEND:20250930T203000
SUMMARY:Culto Evangelístico — Sección I (Cristal)
LOCATION:Cristal, Maunabo, PR
END:VEVENT

END:VCALENDAR
</script>

<!-- ===== Etiquetas dinámicas Mar/Mié — Semana con DOMINGO como inicio ===== -->
<script>
(function(){
  const tz = "America/Puerto_Rico";
  const now = new Date();
  const pr = new Date(now.toLocaleString('en-US', { timeZone: tz }));

  // Domingo = inicio
  const dowSun0 = pr.getDay(); // 0=Dom,1=Lun,...6=Sáb
  const sunday = new Date(pr); sunday.setHours(0,0,0,0); sunday.setDate(pr.getDate() - dowSun0);

  const tuesday = new Date(sunday);   tuesday.setDate(sunday.getDate() + 2);
  const wednesday = new Date(sunday); wednesday.setDate(sunday.getDate() + 3);

  const elMartes = document.getElementById('lbl-martes');
  const elMiercoles = document.getElementById('lbl-miercoles');
  if (elMartes)    elMartes.textContent    = `Martes ${tuesday.getDate()}`;
  if (elMiercoles) elMiercoles.textContent = `Miércoles ${wednesday.getDate()}`;
})();
</script>

<!-- === Leer ICS embebido y actualizar títulos + direcciones + mapas (semana desde DOMINGO) === -->
<script>
(function(){
  const TZ = 'America/Puerto_Rico';

  // Utils
  const toPR = d => new Date(d.toLocaleString('en-US',{timeZone:TZ}));
  const startOfDay = d => (d=new Date(d), d.setHours(0,0,0,0), d);
  const addDays = (d,n)=> (d=new Date(d), d.setDate(d.getDate()+n), d);
  const sameDayPR = (a,b)=>{a=toPR(a);b=toPR(b);
    return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()};
  // ISO date formatter
  const toISO = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  };

  // Semana con DOMINGO como inicio
  const now = new Date();
  const prNow = toPR(now);
  const dowSun0 = prNow.getDay(); // 0..6
  const sunday = startOfDay(addDays(prNow, -dowSun0));
  const tuesday = addDays(sunday, 2);
  const wednesday = addDays(sunday, 3);

  // Pins exactos por fecha (YYYY-MM-DD) -> maps.app.goo.gl
  const PIN_LINKS = {
    '2025-09-02': 'https://maps.app.goo.gl/PJ4bF5y8kzK7VtC96?g_st=ipc',
    '2025-09-03': 'https://maps.app.goo.gl/ywk9uNajhMkmKq2Y7?g_st=ipc',
    '2025-09-09': 'https://maps.app.goo.gl/Fuv4KNYBiiqfdAEh8?g_st=ipc',
    '2025-09-10': 'https://maps.app.goo.gl/Fuv4KNYBiiqfdAEh8?g_st=ipc',
    '2025-09-16': 'https://maps.app.goo.gl/4L1rut6fFb5x2pKg8?g_st=ipc',
    '2025-09-17': 'https://maps.app.goo.gl/ffA2tEJkTcRMBbib8?g_st=ipc',
    '2025-09-23': 'https://maps.app.goo.gl/FypEuJLpCWbcjvaGA?g_st=ipc',
    // '2025-09-24': (sin pin)
    '2025-09-30': 'https://maps.app.goo.gl/23QLJ7UV3DJJK4uW9?g_st=ipc'
  };
  const tueKey = toISO(tuesday);
  const wedKey = toISO(wednesday);
  const tuePin = PIN_LINKS[tueKey] || null;
  const wedPin = PIN_LINKS[wedKey] || null;

  // Parser ICS
  const unfold = txt => txt.replace(/(?:\r\n|\n)[ \t]/g,'');
  const getLineVal = (block, prop) => {
    const m = block.match(new RegExp('^'+prop+'(?:;[^:\\n]*)?:(.*)$','mi'));
    return m ? m[1].trim() : null;
  };
  function parseDTSTART(block){
    const m = block.match(/^DTSTART([^:\n]*)?:([^\n]+)$/mi);
    if (!m) return null;
    const params = (m[1]||'').toUpperCase();
    const val = m[2].trim();

    const dOnly = val.match(/^(\d{4})(\d{2})(\d{2})$/);
    if (/VALUE=DATE/.test(params) && dOnly){
      const [_,Y,M,D] = dOnly; return new Date(Date.UTC(+Y,+M-1,+D,4,0,0)); // all-day -> ~00:00 PR
    }
    const dt = val.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/);
    if (dt){
      const [_,Y,M,D,hh,mm,ss,Z] = dt;
      if (/TZID=AMERICA\/PUERTO_RICO/.test(params))
        return new Date(Date.UTC(+Y,+M-1,+D,+hh+4,+mm,+ss));
      if (Z) return new Date(Date.UTC(+Y,+M-1,+D,+hh,+mm,+ss));
      return new Date(Date.UTC(+Y,+M-1,+D,+hh+4,+mm,+ss));
    }
    if (dOnly){
      const [_,Y,M,D] = dOnly; return new Date(Date.UTC(+Y,+M-1,+D,4,0,0));
    }
    return null;
  }

  // Leer ICS embebido
  const icsEl = document.getElementById('ics-data');
  const raw = icsEl ? icsEl.textContent.trim() : '';
  if (!raw) return;

  const t = unfold(raw);
  const blocks = t.split(/BEGIN:VEVENT/).slice(1).map(b=>'BEGIN:VEVENT'+b.split('END:VEVENT')[0]);

  let tueEv=null, wedEv=null;
  for (const ev of blocks){
    const dt = parseDTSTART(ev); if (!dt) continue;
    if (!tueEv && sameDayPR(dt,tuesday))   tueEv = {summary:getLineVal(ev,'SUMMARY'), location:getLineVal(ev,'LOCATION')};
    if (!wedEv && sameDayPR(dt,wednesday)) wedEv = {summary:getLineVal(ev,'SUMMARY'), location:getLineVal(ev,'LOCATION')};
    if (tueEv && wedEv) break;
  }

  // Títulos y direcciones
  const tTitle = document.getElementById('title-martes');
  const wTitle = document.getElementById('title-miercoles');
  const tAddr  = document.getElementById('addr-martes');
  const wAddr  = document.getElementById('addr-miercoles');

  if (tTitle && tueEv?.summary) tTitle.textContent = tueEv.summary;
  if (wTitle && wedEv?.summary) wTitle.textContent = wedEv.summary;
  if (tAddr  && tueEv?.location) tAddr.textContent = tueEv.location;
  if (wAddr  && wedEv?.location) wAddr.textContent = wedEv.location;

  // Mapas (normalizar LOCATION para evitar saltos a lugares erróneos)
  const tueIframe = document.querySelector('#ubicacion-cultos .grid.cols-2 > div:nth-child(1) iframe');
  const wedIframe = document.querySelector('#ubicacion-cultos .grid.cols-2 > div:nth-child(2) iframe');

  // Normaliza una ubicación para que Google Maps no se confunda
  function normalizeLocation(raw){
    if (!raw) return 'Maunabo, Puerto Rico';

    // Toma la parte más “lugar” si viene con guiones o slash
    let txt = String(raw).split(/[-–—/|]/).pop().trim();

    // Limpia paréntesis y espacios duplicados
    txt = txt.replace(/\s*\(.*?\)\s*/g,' ').replace(/\s{2,}/g,' ').trim();

    // Municipios cercanos conocidos
    const municipios = ['Maunabo','Emajagua','Yabucoa','Humacao','Las Piedras','Patillas','Guayama','San Lorenzo'];
    const hasMunicipio = municipios.some(m => new RegExp(`\\b${m}\\b`,`i`).test(txt));

    if (hasMunicipio) {
      // Asegura “Puerto Rico”
      if (!/puerto\s*rico/i.test(txt)) txt += ', Puerto Rico';
      return txt;
    }

    // Si no menciona municipio, ata por defecto a Maunabo, Puerto Rico
    return `${txt}, Maunabo, Puerto Rico`;
  }

  function setMap(iframeEl, locationText, pinUrl) {
    if (!iframeEl) return;
    const query = normalizeLocation(locationText);

    // Establece el mapa embebido usando la misma query normalizada
    iframeEl.src   = 'https://www.google.com/maps?output=embed&q=' + encodeURIComponent(query);
    iframeEl.title = 'Mapa: ' + query;

    // Overlay clickeable para abrir Google Maps en nueva pestaña con la MISMA query
    let overlay = iframeEl.parentElement.querySelector('.map-overlay');
    if (!overlay) {
      overlay = document.createElement('a');
      overlay.className = 'map-overlay';
      overlay.target = '_blank';
      overlay.rel = 'noopener';
      overlay.style.cssText = 'position:absolute;inset:0;z-index:5;';
      const holder = iframeEl.parentElement;
      const cs = getComputedStyle(holder);
      if (cs.position === 'static') holder.style.position = 'relative';
      holder.appendChild(overlay);
    }
    overlay.href = pinUrl || ('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(query));
  }

  setMap(tueIframe, tueEv?.location, tuePin);
  setMap(wedIframe, wedEv?.location, wedPin);
})();
</script>

<script>
// ===== Detectar si el canal está EN VIVO y mostrar reproductor debajo del botón de YouTube =====
(function(){
  // Configura tu canal
  const CHANNEL_HANDLE = '@pipjm9752';
  // Si conoces el CHANNEL_ID (UCxxxxxxxx...), colócalo aquí para poder embeber el player directamente
  const CHANNEL_ID = ''; // <-- si lo añades, verás el reproductor dentro de la página

  const liveBox = document.getElementById('live-wrap');
  const livePlayer = document.getElementById('live-player');
  const liveCta = document.getElementById('live-cta');
  if (!liveBox) return;

  const liveUrl = `https://www.youtube.com/${CHANNEL_HANDLE}/live`;
  if (liveCta) liveCta.href = liveUrl;

  // Truco sin API: oEmbed devuelve 200 si hay directo, 404 si no.
  const oembed = `https://www.youtube.com/oembed?url=${encodeURIComponent(liveUrl)}&format=json`;

  fetch(oembed, { mode: 'cors' })
    .then(r => {
      if (!r.ok) throw new Error('offline');
      return r.json();
    })
    .then(() => {
      // EN VIVO
      liveBox.style.display = 'block';
      // Si tenemos CHANNEL_ID, insertamos el reproductor incrustado. Si no, dejamos el CTA.
      if (CHANNEL_ID) {
        const src = `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(CHANNEL_ID)}&autoplay=1&mute=1&rel=0&modestbranding=1`;
        livePlayer.innerHTML = `<iframe src="${src}" title="YouTube live" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
      } else {
        // Sin CHANNEL_ID: mostramos un mini aviso y dejamos el botón "Ver en YouTube"
        livePlayer.innerHTML = '';
      }
    })
    .catch(() => {
      // OFFLINE: no mostramos nada
      liveBox.style.display = 'none';
    });
})();
</script>
<!-- ===== Botones de suscripción (iCloud/Google) ===== -->
<script>
document.getElementById("btn-ios").addEventListener("click", function(event) {
  event.preventDefault();
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const url = "webcal://p158-caldav.icloud.com/published/2/MTYyMzg4NDUwMjAxNjIzOFc_RCw-iCOSeM_LMqkWZcQMuX9sTzZF-PyrU9d06Oy4V0VhxUSZVqCmqzUsygyCHgAllfl2DFW34WcFi8EvPD8";

  if (window.self !== window.top && isIOS) {
    window.top.location.href = url;
  } else {
    window.location.href = url;
  }
  setTimeout(function() {
    alert("Si no se abrió el calendario, copia y pega este enlace en Safari:\n" + url);
  }, 2500);
});

const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const isAndroid = /Android/i.test(navigator.userAgent);

// --- Botón: mostrar opciones (Web/App) ---
const CAL_ID  = "72086005a3ac9a324642e6977fb8f296d531c3520b03c6cf342495ed215e0186@group.calendar.google.com";
const WEB_URL = "https://calendar.google.com/calendar/u/0/r?cid=" + encodeURIComponent(CAL_ID);
// Dynamic Link que abre la app si está instalada y, si no, va a la tienda


const choice    = document.getElementById("gcal-choice");
const openWeb   = document.getElementById("gcal-open-web");
const openApp   = document.getElementById("gcal-open-app");
const cancelBtn = document.getElementById("gcal-cancel");

function hideChoice(){ if (choice) choice.style.display = "none"; }
function showChoice(){ if (choice) choice.style.display = "flex"; }

document.getElementById("btn-gcal").addEventListener("click", function (event) {
  event.preventDefault();
  showChoice();
});

// Abrir en la web: URL que pide suscribirse al calendario
if (openWeb){
  openWeb.addEventListener("click", function(e){
    e.preventDefault();
    hideChoice();
    // Abrimos la VERSIÓN WEB en nueva pestaña para minimizar cualquier deep link
    try {
      const w = window.open(WEB_URL, "_blank", "noopener");
      if (!w) {
        // Si el navegador bloquea popups, navega en la misma pestaña
        window.location.href = WEB_URL;
      }
    } catch(_) {
      window.location.href = WEB_URL;
    }
  });
}

// Abrir en la app: usa Dynamic Link para todos los casos
if (openApp){
  openApp.addEventListener("click", function(e){
    e.preventDefault();
    hideChoice();

    // Navega a una URL (considerando si estamos dentro de un iframe)
    const go = (url) => {
      if (window.self !== window.top) { window.top.location.href = url; }
      else { window.location.href = url; }
    };

    if (isAndroid) {
      // ANDROID: intenta abrir la app con intent + cid.
      // Si no abre, cae primero a Web Add; último recurso: Play Store.
      const PLAY = "https://play.google.com/store/apps/details?id=com.google.android.calendar";
      const intentUrl =
        'intent://calendar.google.com/calendar/r?cid=' + encodeURIComponent(CAL_ID) +
        '#Intent;scheme=https;package=com.google.android.calendar;' +
        'S.browser_fallback_url=' + encodeURIComponent(WEB_URL) + ';end';

      let finished = false;
      const finish = () => {
        if (finished) return;
        finished = true;
        clearTimeout(toWeb);
        clearTimeout(toStore);
      };

      // Dispara intent
      go(intentUrl);

      // Si realmente se abre la app, la página pierde foco/visibilidad
      const onHidden = () => finish();
      window.addEventListener('pagehide', onHidden, { once:true });
      document.addEventListener('visibilitychange', () => { if (document.hidden) finish(); }, { once:true });
      window.addEventListener('blur', onHidden, { once:true });

      // Fallback 1: si seguimos visibles, usar Web (ahí sí pregunta para agregar)
      const toWeb = setTimeout(() => {
        if (!finished && !document.hidden) go(WEB_URL);
      }, 2200);

      // Fallback 2 (último recurso): Play Store si tampoco abrió ni fue a Web
      const toStore = setTimeout(() => {
        if (!finished && !document.hidden) go(PLAY);
      }, 4500);

      return;
    } else if (isIOS) {
      // iOS: intenta abrir la app con el CID directamente. Fallback: App Store.
      const appUrl1 = "comgooglecalendar://?cid=" + encodeURIComponent(CAL_ID);
      const appUrl2 = "googlecalendar://?cid=" + encodeURIComponent(CAL_ID);
      const appStore = "https://apps.apple.com/app/google-calendar/id909319292";

      let left = false;
      const cleanup = () => {
        document.removeEventListener("visibilitychange", onVis, true);
        window.removeEventListener("pagehide", onHide, true);
        window.removeEventListener("blur", onBlur, true);
      };
      const onVis  = () => { if (document.hidden) { left = true; cleanup(); } };
      const onHide = () => { left = true; cleanup(); };
      const onBlur = () => { left = true; cleanup(); };

      document.addEventListener("visibilitychange", onVis, true);
      window.addEventListener("pagehide", onHide, true);
      window.addEventListener("blur", onBlur, true);

      go(appUrl1);
      setTimeout(() => { if (!left) go(appUrl2); }, 600);
      setTimeout(() => { if (!left) go(appStore); }, 1800);

    } else {
      // Otros (desktop): abrir versión web como último recurso
      go(WEB_URL);
    }
  });
}

// Botón de descarga Google Calendar
const btnDownload = document.getElementById("btn-download");
if (btnDownload){
  btnDownload.addEventListener("click", function(e){
    e.preventDefault();
    const PLAY = "https://play.google.com/store/apps/details?id=com.google.android.calendar";
    const APPSTORE = "https://apps.apple.com/app/google-calendar/id909319292";
    if (isAndroid) {
      window.location.href = PLAY;
    } else if (isIOS) {
      window.location.href = APPSTORE;
    } else {
      window.location.href = "https://calendar.google.com/"; // fallback
    }
  });
}

// Cerrar modal
if (cancelBtn){
  cancelBtn.addEventListener("click", function(){
    hideChoice();
  });
}
if (choice){
  choice.addEventListener("click", function(e){
    if (e.target === choice) hideChoice();
  });
}
</script>
  <script>
    const openBtn = document.getElementById('open-contact-options');
    const modal   = document.getElementById('contact-modal');
    const closeBtn= document.getElementById('close-modal');

    if(openBtn && modal){
      openBtn.addEventListener('click', e=>{
        e.preventDefault();
        modal.style.display = 'flex';
      });
    }
    if(closeBtn){
      closeBtn.addEventListener('click', ()=> modal.style.display='none');
    }
    window.addEventListener('click', e=>{
      if(e.target === modal) modal.style.display='none';
    });
  </script>
  <script>
  // Oculta el header al bajar y lo muestra al subir (sin tocar el layout)
  (function(){
    const header = document.querySelector('header');
    if (!header) return;

    let lastY = window.scrollY || 0;
    let downAccum = 0, upAccum = 0;
    const THRESH = 12;      // píxeles de histéresis para evitar parpadeos
    const MIN_TOP = 24;     // no ocultar si estamos pegados al tope

    window.addEventListener('scroll', () => {
      const y = window.scrollY || 0;
      const delta = y - lastY;

      if (delta > 0){
        // Bajando
        downAccum += delta; upAccum = 0;
        if (y > MIN_TOP && downAccum > THRESH){
          header.classList.add('hide');
        }
      } else if (delta < 0){
        // Subiendo
        upAccum += -delta; downAccum = 0;
        if (upAccum > THRESH){
          header.classList.remove('hide');
        }
        if (y <= 0){
          header.classList.remove('hide');
        }
      }

      lastY = y;
    }, { passive: true });
  })();
  </script>
<!-- Removed two stray closing script tags below -->
<script>
(function(){
  // Duraciones
  const MIN_VISIBLE = 1500;   // tiempo mínimo visible ANTES de empezar el fade
  const FADE_TIME   = 2000;   // debe coincidir con el CSS (2000ms)
  const HARD_FALLBACK = MIN_VISIBLE + FADE_TIME + 1500; // por si algo falla

  const start = performance.now();

  const done = () => {
    document.documentElement.classList.remove('loading');
    const el = document.getElementById('loader');
    if (!el) return;
    el.classList.add('hide');
    // Quita el estilo que oculta el contenido tras el fade
    const style = document.getElementById('preload-style');
    if (style) style.remove();
    // tras el fade, elimina el nodo
    setTimeout(() => { try { el.remove(); } catch(_){} }, FADE_TIME + 100);
  };

  // Cuando todo cargue, espera lo necesario para cumplir el mínimo visible
  window.addEventListener('load', () => {
    const elapsed = performance.now() - start;
    const wait = Math.max(0, MIN_VISIBLE - elapsed);
    setTimeout(done, wait);
  }, { once: true });

  // Fallback duro por si el 'load' nunca llega
  setTimeout(done, HARD_FALLBACK);
})();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(function(reg) {
        console.log('✅ Service Worker registrado con éxito:', reg);
      })
      .catch(function(err) {
        console.log('❌ Error al registrar Service Worker:', err);
      });
  }
</script>
<script>
(function(){
  const btn = document.getElementById('btn-notifs');
  if (!btn) return;

  // Solo mostrar en modo app por si acaso (CSS ya lo hace, esto es refuerzo)
  const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
  if (!isStandalone) { btn.style.display = 'none'; return; }

  function setState(){
    const p = (typeof Notification !== 'undefined') ? Notification.permission : 'default';
    if (p === 'granted'){
      btn.classList.add('ok');
      btn.textContent = '✅ NOTIFICACIONES';
    } else if (p === 'denied'){
      btn.classList.remove('ok');
      btn.textContent = '🚫 NOTIFICACIONES';
    } else {
      btn.classList.remove('ok');
      btn.textContent = 'NOTIFICACIONES';
    }
  }

  setState();

  btn.addEventListener('click', async (e)=>{
    e.preventDefault();
    if (typeof Notification === 'undefined'){
      alert('Este dispositivo no soporta notificaciones.');
      return;
    }
    // Si ya están concedidas, no pedimos de nuevo
    if (Notification.permission === 'granted'){
      btn.classList.add('ok');
      btn.textContent = '✅ NOTIFICACIONES';
      return;
    }
    // Mostrar "reloj de arena" mientras se pide el permiso
    const original = btn.textContent;
    btn.classList.add('loading');
    btn.textContent = '⏳ NOTIFICACIONES';

    try{
      const perm = await Notification.requestPermission();
      if (perm === 'granted'){
        btn.classList.add('ok');
        btn.textContent = '✅ NOTIFICACIONES';
      } else if (perm === 'denied'){
        btn.classList.remove('ok');
        btn.textContent = '🚫 NOTIFICACIONES';
      } else {
        btn.classList.remove('ok');
        btn.textContent = 'NOTIFICACIONES';
      }
    } catch(e){
      console.warn('Permiso notificaciones falló:', e);
      btn.classList.remove('ok');
      btn.textContent = original;
    } finally {
      btn.classList.remove('loading');
    }
  });
})();
</script>
</script>
<script>
(function(){
  const btn = document.getElementById('btn-install');
  if (!btn) return;

  const ua = navigator.userAgent || '';
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isSafari = /Safari/i.test(ua) && !/CriOS|FxiOS|OPiOS|EdgiOS/i.test(ua);
  const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);

  // Ocultar si ya está instalada (defensa adicional al CSS)
  if (isStandalone) { btn.style.display = 'none'; return; }

  // Por defecto: mostrar el botón en la web
  btn.style.display = '';

  let deferredPrompt = null;

  // ANDROID/CHROME: capturar beforeinstallprompt (seguirá usando prompt nativo)
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
  });

  btn.addEventListener('click', async (ev) => {
    ev.preventDefault();

    // iOS: instrucciones (no se puede abrir el diálogo nativo por código)
    if (isIOS && isSafari && !isStandalone) {
      alert('PASO 1: PRESIONA LOS TRES PUNTOS (ABAJO DERECHA O ARRIBA DERECHA)\\n\\nPASO 2: SELECCIONA "COMPARTIR"\\n\\nPASO 3: DESLIZA HASTA VER "AGREGAR A INICIO"\\n\\nPASO 4: PRESIONA "AGREGAR"');
      return;
    }

    // Android/desktop soportados
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        btn.style.display = 'none';
      }
      deferredPrompt = null;
    } else {
      // Instrucciones genéricas (incluye macOS Safari)
      const isMac = /Macintosh|Mac OS X/i.test(ua);
      if (isMac && isSafari) {
        alert('En macOS (Safari):\\n\\nArchivo → Añadir al Dock\\n\\nLuego abre desde el Dock.');
      } else {
        alert('Si tu navegador soporta instalación, busca el ícono de “instalar” o usa el menú del navegador para “Añadir a pantalla de inicio / Instalar app”.');
      }
    }
  });

  // Cuando se instala, ocultar el botón
  window.addEventListener('appinstalled', () => {
    btn.style.display = 'none';
  });
})();
</script>
<img src="https://raw.githubusercontent.com/dla-tech/Media-privada/refs/heads/main/Logo%20de%20la%20iglesia%20PIPJM-2.png" alt="Logo fijo" class="fixed-logo">
</body>
</html>
